
library(argosTrack)



## Simulation

nObs <- 500
dates <- Sys.time() + (0:(nObs-1)) * 60 * 60 * 24
m0 <- argosTrack:::OUL(dates,timeunit="day")

set.seed(1)
X <- m0$simulate()
Y <- X + rnorm(nObs*2,0,0.5)

plot(t(Y)); lines(t(X))

an <- Animal(Observation(lon = Y[1,],
                         lat = Y[2,],
                         dates = dates,
                         locationclass = rep("GPS",nObs)),
             argosTrack:::OUL(dates,timeunit="day"),
             Measurement(model="n"))

plot(an)


## "export" all functions
ns <- asNamespace("argosTrack")
allf <- ls(ns)
for(f in allf)
    eval(parse(text = sprintf('%s <- get("%s",ns)',f,f)))
## end "export" all functions

## Define "new" movement model
OUL2 <- setRefClass("OUL2",
                    contains = "OUL",
                    methods = list(
                        getTMBmap = function(...){
                            map <- list()
                            mpar <- 1:6
                            mpar[c(2:3)] <- NA
                            map$movePars <- factor(mpar)
                            return(map)
                        }))

an <- Animal(Observation(lon = Y[1,],
                         lat = Y[2,],
                         dates = dates,
                         locationclass = rep("K",nObs)),
             OUL2(dates,timeunit="day"),
             Measurement(model="n"))


fitTrack(an, symdecay = TRUE)


an
plot(an)



## Data from Blackwell et al. 2016 DOI: 10.1111/2041-210X.12460

d0 <- data.frame("x" = c(9.1396175068,8.7488504199,9.1749125985,8.6920115709,8.8563400174,9.49761058,9.0241062975,8.2703039815,9.1178445606,9.1476391186,8.9370145128,6.6185395268,8.5455598591,8.9789560828,9.1680369313,9.0555051779,9.6481876921,9.4096020396,9.035336554,9.0172306303,9.3704107365,9.195997978,9.3140302653,9.6821076504,9.2349600923,9.0500046441,8.7894168565,8.8221908702,9.4272495855,8.9617669148,8.9264718231,9.0733819126,8.4364659393,9.814120461,9.2395438704,9.3328237557,9.1710163871,9.1148651048,9.0137927967,9.1139483492,9.4916516684,9.0834662246,9.9903667307,9.3055502757,9.4875262681,9.0206684639,8.2737418151,8.9920198505,8.946411258,8.5604571381,9.4847760012,8.4531967295,8.8396092272,8.7273066626,8.7937714458,9.2099785014,8.6557997236,9.0369408764,8.8742167522,8.9273885787,9.0903418918,8.5845219734,8.8260870817,8.7071380388,8.9890403948,9.1238034722,9.1998941894,8.4091924593,7.9343130434,9.0027917292,8.867341085,8.4981177554,8.0461572302,8.867341085,8.9729971712,9.0855289247,9.3186140434,8.3534995549,9.0756738017,8.892093487,9.0211268418,8.8258578928,8.8325043711,9.0250230532,10.7159788111,8.9943117396,8.9796436495,8.9303680345,7.223369053,8.4690107641,7.6810593009,9.0715484014,9.0337322317,9.4721706113,9.4458138869,9.0190641416,9.0646727341,9.057567878,8.9732263602,9.3951631385,8.8290665375,9.1998941894,9.2308346919,8.8700913519,8.9083658994,8.778415789,8.8836134974,8.8833843085,9.1609320752,10.3236074018,8.699345616,7.5669232251,9.7316124543,8.7344115187,7.1738642491,6.3210523251,10.5117714947,9.4132690621,8.5462474259,8.9917906616,9.0541300444,8.7199726176,8.973455549,9.2544411494,9.4389382197,8.8444221943,9.0832370356,4.5572144946,5.2337801489),
                 "y" = c(4.6006370675,3.2015099659,3.5819317754,3.2779583678,3.0659050625,3.76577198,3.7948951807,3.1444770311,3.3680582701,3.3583505365,2.96488396,2.8923793248,3.9775219186,3.444506672,3.432372005,3.5291459741,2.5887092839,3.3683616367,3.258239534,3.420237338,3.4411696385,3.3292273358,3.1675328984,3.1820944988,3.36441787,3.1924089657,3.2840257013,3.4924386065,3.3495529029,2.9218058922,3.5837519755,3.1599487315,2.7200670539,4.766882005,3.9820724187,4.3427753944,3.3601707365,3.4842477063,3.7524238463,3.3134522687,4.5244920323,3.49850594,3.3201263355,2.7822572221,2.4570481473,3.3258903023,4.8624425074,3.7287612457,2.9670075267,2.6014506842,2.6235964515,3.3798895704,3.5606961082,4.1786540237,4.0585208207,3.1001854967,3.8761974494,3.8725570494,3.4429898386,3.1089831302,3.1778473653,5.0095753444,3.3295307024,3.2100042328,3.3947545374,4.0551837873,2.7045953535,3.4796972062,3.2746213344,3.4605851057,3.6383579768,4.5608960332,3.1411399977,3.1283985974,3.0355683951,3.6198526097,3.1802742987,4.460481664,3.4032488043,3.4284282382,3.8680065492,3.6338074767,3.6659643442,3.4624053058,3.4253945715,3.4244844715,3.5931563424,3.1675328984,4.4535042305,3.7669854467,3.2297230666,2.8732672244,3.3968781041,3.2297230666,3.3786761037,3.6441219436,3.9878363856,3.0258606615,3.2834189679,3.5503816413,4.2408441919,3.0871407297,2.1336592725,3.9678141851,3.8670964492,3.6459421437,3.5294493408,3.3207330689,3.4363157718,1.9131117004,3.5194382405,3.8495011821,3.1071629302,3.3222499023,3.3292273358,4.5141775654,2.6803260195,2.1360862059,3.0804666629,3.4260013049,3.3428788361,3.2194085997,3.7324016458,3.0000744942,2.911794792,3.5349099409,3.6984245783,4.7077255036,4.6151986679),
                 "time" = c(1,2,3,4,5,6,7,8,9,10,11,12,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,39,40,41,42,43,44,45,46,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132))

obs <- Observation(lon = d0$x,
                   lat = d0$y,
                   dates = Sys.time() + d0$time * 60 * 60 * 24,
                   locationclass = rep("K",dim(d0)[1]))

plot(obs)

anim <- Animal(obs,
               argosTrack:::OUL(obs$dates, timeunit="day", pars = c(-1,0,0,-1,mean(obs$lat),mean(obs$lon))),
               Measurement(model = "n"))

anim1 <- Animal(obs,
               OUL2(obs$dates, timeunit="day", pars=c(-1,0,0,-1,mean(obs$lat),mean(obs$lon))),
               Measurement(model = "n"))


anim2 <- Animal(obs,
               argosTrack:::IDCRW(obs$dates, timeunit="day"),
               Measurement(model = "n"))

anim3 <- Animal(obs,
               argosTrack:::CTCRW(obs$dates, timeunit="day"),
               Measurement(model = "n"))

anim4 <- Animal(obs,
               argosTrack:::RW(obs$dates, timeunit="day"),
               Measurement(model = "n"))

plot(anim)

fitTrack(anim)

fitTrack(anim1)

fitTrack(anim2)

fitTrack(anim3)

fitTrack(anim4)

plot(anim2)


anim
anim1


obj <- TMB::MakeADFun(anim1$getTMBdata(),anim1$getTMBparameters(),anim1$getTMBmap(),random="mu",DLL="argosTrack")
obj$par

obj$gr()

obj$fn()

opt <- nlminb(obj$par,obj$fn,obj$gr)

obj$report()$splineSd

spl <- anim4$measurement$reportSpline
ci <- c(spl[,1] + 2 * spl[,2], rev(spl[,1] - 2 * spl[,2]))
plot(0,type="n",ylim = range(ci),xlim=c(1,366))
polygon(c(1:366,366:1),ci,col="grey",border=NA)
lines(1:366,spl[,1],lwd=4)
rug(anim4$observation$dayOfYear)
